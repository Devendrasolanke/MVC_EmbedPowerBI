@model List<AppOwnsData.Models.UserAccessMaster>

@{
    ViewBag.Title = "Admin Panel";
    Layout = null;

    var reportTable = ViewBag.ReportTable as System.Data.DataTable; // ✅ Reports table provided from controller
}

<style>
    body {
        background-color: #f5f9ff;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
    }

    .container-flex {
        display: flex;
        height: 100vh;
    }

    /* Sidebar */
    .sidebar {
        width: 200px;
        background-color: #094780;
        color: white;
        display: flex;
        flex-direction: column;
        padding: 15px;
        box-shadow: 2px 0 10px rgba(0,0,0,0.15);
    }

        .sidebar h3 {
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 18px;
        }

    .sidebar-item {
        padding: 10px 12px;
        margin-bottom: 6px;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.2s;
        font-weight: 500;
        background-color: rgba(255,255,255,0.15);
        font-size: 14px;
    }

        .sidebar-item:hover,
        .sidebar-item.active {
            background-color: rgba(255,255,255,0.35);
        }


    /* Content */
    .content {
        flex-grow: 1;
        padding: 20px 30px;
        position: relative;
        overflow-y: auto;
    }

    .top-bar {
        position: absolute;
        top: 20px;
        right: 25px;
    }

    .logout-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 7px 16px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
    }

        .logout-btn:hover {
            background-color: #b02a37;
        }

    h2 {
        color: #094780;
        font-weight: 700;
        margin-bottom: 20px;
        margin-top: 20px;
    }

    /* Table */
    .styled-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: rgba(0,0,0,0.1) 0 4px 20px;
    }

        .styled-table th,
        .styled-table td {
            text-align: center;
            vertical-align: middle;
        }

        .styled-table th {
            background-color: #094780;
            color: white;
            padding: 12px;
            font-size: 14px;
        }

        .styled-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }

    .btn-primary {
        background-color: #0d6efd;
        border: none;
        padding: 7px 12px;
        border-radius: 6px;
        color: white !important;
        font-size: 14px;
        text-decoration: none !important;
    }

    /* ✅ Custom Buttons */
    .action-btn {
        padding: 6px 14px;
        border-radius: 6px;
        color: white !important;
        font-size: 13px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        text-decoration: none !important;
        display: inline-block;
        transition: 0.2s ease;
    }

    .btn-edit {
        background-color: #f0ad4e;
    }

        .btn-edit:hover {
            background-color: #d99132;
        }

    .btn-delete {
        background-color: #dc3545;
    }

        .btn-delete:hover {
            background-color: #b02a37;
        }


    /* ✅ Popup */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        backdrop-filter: blur(3px);
    }

    .popup-box {
        background: white;
        width: 350px;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 8px 25px rgba(0,0,0,0.25);
    }

    .btn-yes {
        background-color: #dc3545;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
    }

    .btn-cancel {
        background-color: #6c757d;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
    }

    .filter-icon {
        cursor: pointer;
        font-size: 13px;
        margin-left: 5px;
    }

    .excel-filter-dropdown {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 10px;
        display: none;
        width: 220px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 5000;
    }

    .filter-search input {
        width: 100%;
        padding: 6px;
        margin-bottom: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
    }

    .filter-checkbox-container {
        max-height: 180px;
        overflow-y: auto;
        border: 1px solid #eee;
        padding: 5px;
    }

    .filter-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
    }

        .filter-buttons button {
            padding: 6px 12px;
            border: none;
            background-color: #094780;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }

    .powerbi-header {
        display: flex;
        flex-direction: column;
        align-items: center; /* ✅ Horizontal center */
        justify-content: center; /* ✅ Vertical alignment */
        text-align: center;
        margin-bottom: 25px;
        margin-top: 10px;
    }

        .powerbi-header img {
            width: 55px;
            height: auto;
            margin-right: 0px;
        }

        .powerbi-header span {
            font-size: 16px;
            font-weight: 700;
            color: #ffc107; /* ✅ Power BI Yellow */
            letter-spacing: 1px;
        }

    .form-group {
        margin-bottom: 20px;
        width: 100%;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 5px;
        text-align: left;
    }

    .form-control {
        width: 100%;
        border-radius: 10px;
        border: 1px solid #ccc;
        height: 42px;
        font-size: 15px;
        padding: 8px 12px;
        box-sizing: border-box;
    }

        .form-control:focus {
            border-color: #0d6efd;
            outline: none;
            box-shadow: 0 0 4px rgba(13, 110, 253, 0.3);
        }

    /* Popup overlay */
    .center-popup {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.45);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 5000;
        animation: fadeInScale 0.3s ease-out;
    }

        .center-popup .popup-content {
            background: white;
            padding: 25px 35px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0px 6px 20px rgba(0,0,0,0.25);
            min-width: 280px;
        }

        .center-popup.success .popup-content {
            background-color: #28a745;
            color: #fff;
        }

        .center-popup.error .popup-content {
            background-color: #dc3545;
            color: #fff;
        }

    /* ✅ FIX: Razor needs only 1 */
    @@keyframes fadeInScale {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes popIn {
        from {
            transform: scale(0.7);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>

<div class="container-flex">

    <!-- ✅ Sidebar -->
    <div class="sidebar">
        @*<h3>Admin Panel</h3>*@
        <div class="powerbi-header">
            <img src="~/Content/Images/icon-power-bi.png" alt="Power BI Logo" />
            <span>Admin Panel</span>
        </div>

        <div class="sidebar-item" onclick="showSection('users')">
            👥 Manage Users
        </div>

        <div class="sidebar-item" onclick="showSection('reports')">
            📊 Manage Reports
        </div>

        <div class="sidebar-item" onclick="showSection('forgot')">
            🔐 Forgot Password
        </div>
    </div>


    <!-- ✅ Content Area -->
    <div class="content">

        <!-- ✅ Top Right -->
        <div class="top-bar">
            <span style="margin-right:15px; font-weight: 500; color:#094780;">
                👤 @Session["UserID"]
            </span>

            <form action="/Login/Logout" method="post" style="display:inline;">
                <button class="logout-btn">Logout</button>
            </form>
        </div>

        <!-- ✅ USERS SECTION -->
        <div id="usersSection">

            <br /><br />

            <a href="@Url.Action("Create", "Admin")" class="btn-primary mb-3">➕ Add New User</a>

            <br /><br />

            <table class="styled-table" id="usersTable">
                <thead>
                    <tr>
                        <th>User Email <span class="filter-icon" onclick="openFilter(this, 0, 'usersTable')">🔽</span></th>
                        <th>Access Report <span class="filter-icon" onclick="openFilter(this, 1, 'usersTable')">🔽</span></th>
                        <th>Plant <span class="filter-icon" onclick="openFilter(this, 2, 'usersTable')">🔽</span></th>
                        <th>Active <span class="filter-icon" onclick="openFilter(this, 3, 'usersTable')">🔽</span></th>
                        <th style="width:160px;">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.UserEmail</td>
                            <td>@item.ReportName</td>
                            <td>@item.Plant</td>
                            <td>@(item.Active == "Y" ? "Yes" : "No")</td>
                            <td>
                                <a href="@Url.Action("Edit","Admin", new { id=item.SrNo })"
                                   class="action-btn btn-edit">Edit</a>

                                <button class="action-btn btn-delete"
                                        onclick="openDeletePopup('user', @item.SrNo)">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

        </div>


        <!-- ✅ REPORTS SECTION -->
        <div id="reportsSection" style="display:none;">

            <br /><br />

            <a href="/Reports/Create" class="btn-primary mb-3">➕ Add New Report</a>

            <br /><br />

            <table class="styled-table" id="reportsTable">
                <thead>
                    <tr>
                        <th>Report Name <span class="filter-icon" onclick="openFilter(this, 0, 'reportsTable')">🔽</span></th>
                        <th>Report ID <span class="filter-icon" onclick="openFilter(this, 1, 'reportsTable')">🔽</span></th>
                        <th>Report Filter <span class="filter-icon" onclick="openFilter(this, 2, 'reportsTable')">🔽</span></th>
                        <th width="160px">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    @if (reportTable != null && reportTable.Rows.Count > 0)
                    {
                        foreach (System.Data.DataRow row in reportTable.Rows)
                        {
                            <tr>
                                <td>@row["ReportName"]</td>
                                <td>@row["ReportID"]</td>
                                <td>@row["ReportFilter"]</td>

                                <td>
                                    <a href="/Reports/Edit/@(row["RepID"])" class="action-btn btn-edit">Edit</a>

                                    <button class="action-btn btn-delete"
                                            onclick="openDeletePopup('report', @(row["RepID"]))">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" style="text-align:center; padding:20px;">
                                No reports found!
                            </td>
                        </tr>
                    }
                </tbody>

            </table>

        </div>

        <!-- ✅ FORGOT PASSWORD SECTION -->
        <div id="forgotSection" style="display:none;">
            <br />
            <br />
            <p style="color:orange">Enter the user email to reset password.</p>

            @using (Html.BeginForm("ForgotPassword", "Admin", FormMethod.Post))
            {
                <div class="form-group" style="margin-bottom:15px; max-width:350px;">
                    @*<label style="font-weight:600;">User Email</label>*@
                    <input type="text" name="email" class="form-control" placeholder="Enter Email" required />
                </div>

                <button type="submit" class="btn-primary">Reset Password</button>
            }

            <!-- ✅ TempData message -->
            @if (TempData["msg"] != null)
            {
                <div style="margin-top:20px; font-weight:600; color:#dc3545;">
                    @TempData["msg"]
                </div>
            }
        </div>

    </div>

</div>

<!-- ✅ Excel Filter Dropdown -->
<div id="excelFilterDropdown" class="excel-filter-dropdown">
    <div class="filter-search">
        <input type="text" id="filterSearchInput" placeholder="Search..." onkeyup="filterDropdownList()" />
    </div>

    <div class="filter-checkbox-container">

        <!-- ✅ Select / Deselect All -->
        <label style="font-weight:600;">
            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
            Select / Deselect All
        </label>
        <hr />

        <!-- ✅ Values will be populated here -->
        <div id="filterCheckboxContainer"></div>
    </div>


    <div class="filter-buttons">
        <button onclick="applyFilter()">OK</button>
        <button onclick="clearFilter()">Clear</button>
    </div>
</div>

<!-- ✅ Dynamic Delete Confirmation Popup (shared for Users & Reports) -->
<div id="deletePopup" class="popup-overlay" style="display:none;">
    <div class="popup-box">
        <h3 id="deletePopupTitle">Delete</h3>
        <p id="deletePopupMessage">Are you sure you want to delete this item?</p>

        <div class="popup-buttons">
            <button class="btn-yes" id="confirmDeleteBtn">Yes, Delete</button>
            <button class="btn-cancel" onclick="closeDeletePopup()">Cancel</button>
        </div>
    </div>
</div>

<!-- ✅ POPUP (success/error) -->
@if (TempData["popupMessage"] != null)
{
    <div id="centerPopup" class="center-popup @(TempData["popupType"])">
        <div class="popup-content">
            <span>@TempData["popupMessage"]</span>
        </div>
    </div>

    <script>
        window.onload = function () {
            const popup = document.getElementById("centerPopup");
            popup.style.display = "flex";

            setTimeout(() => {
                popup.style.opacity = "0";
                setTimeout(() => popup.style.display = "none", 400);
            }, 2500);
        };
    </script>
}

<script>

    // ✅ Toggle all checkboxes ON/OFF
    function toggleSelectAll(master) {
        let all = document.querySelectorAll(".filter-option");
        all.forEach(cb => cb.checked = master.checked);
    }

    // ✅ Update master "Select All" checkbox based on user manual selection
    function updateMasterCheckbox() {
        let all = document.querySelectorAll(".filter-option");
        let master = document.getElementById("selectAllCheckbox");

        let checkedCount = Array.from(all).filter(cb => cb.checked).length;

        if (checkedCount === all.length) {
            master.checked = true;
            master.indeterminate = false;
        }
        else if (checkedCount === 0) {
            master.checked = false;
            master.indeterminate = false;
        }
        else {
            master.indeterminate = true;
        }
    }

    let currentFilterTable = "";
    let currentFilterColumn = -1;
    let selectedValues = [];

    function openFilter(el, colIndex, tableId) {
        const dropdown = document.getElementById("excelFilterDropdown");
        const rect = el.getBoundingClientRect();

        dropdown.style.left = rect.left + "px";
        dropdown.style.top = (rect.bottom + window.scrollY) + "px";
        dropdown.style.display = "block";

        currentFilterTable = tableId;
        currentFilterColumn = colIndex;

        populateUniqueValues(tableId, colIndex);
    }

    function populateUniqueValues(tableId, colIndex) {
        const table = document.getElementById(tableId);
        const rows = table.querySelectorAll("tbody tr");

        let values = new Set();

        rows.forEach(r => {
            const cell = r.querySelectorAll("td")[colIndex];
            if (cell) values.add(cell.innerText.trim());
        });

        const container = document.getElementById("filterCheckboxContainer");
        container.innerHTML = "";

        values.forEach(v => {
            container.innerHTML += `
<label>
    <input type="checkbox" class="filter-option" value="${v}" checked onclick="updateMasterCheckbox()">
    ${v}
</label><br/>
`;
        });
    }

    function filterDropdownList() {
        let searchText = document.getElementById("filterSearchInput").value.toLowerCase();
        let options = document.querySelectorAll(".filter-option");

        options.forEach(opt => {
            let label = opt.parentElement.innerText.toLowerCase();
            opt.parentElement.style.display = label.includes(searchText) ? "block" : "none";
        });
    }

    function applyFilter() {
        const checkboxes = document.querySelectorAll(".filter-option");
        selectedValues = [];

        checkboxes.forEach(cb => {
            if (cb.checked) selectedValues.push(cb.value);
        });

        const table = document.getElementById(currentFilterTable);
        const rows = table.querySelectorAll("tbody tr");

        rows.forEach(row => {
            const cellValue = row.querySelectorAll("td")[currentFilterColumn].innerText.trim();
            row.style.display = selectedValues.includes(cellValue) ? "" : "none";
        });

        closeFilterDropdown();
    }

    function clearFilter() {
        const table = document.getElementById(currentFilterTable);
        const rows = table.querySelectorAll("tbody tr");

        rows.forEach(r => r.style.display = "");

        closeFilterDropdown();
    }

    function closeFilterDropdown() {
        document.getElementById("excelFilterDropdown").style.display = "none";
    }

    // Section switcher (keep)
    function showSection(s) {

        // Remove active from all
        document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));

        // Hide all
        document.getElementById("usersSection").style.display = "none";
        document.getElementById("reportsSection").style.display = "none";
        document.getElementById("forgotSection").style.display = "none";

        // Show selected + highlight
        if (s === "users") {
            document.getElementById("usersSection").style.display = "block";
            document.querySelectorAll(".sidebar-item")[0].classList.add("active");
        }
        else if (s === "reports") {
            document.getElementById("reportsSection").style.display = "block";
            document.querySelectorAll(".sidebar-item")[1].classList.add("active");
        }
        else if (s === "forgot") {
            document.getElementById("forgotSection").style.display = "block";
            document.querySelectorAll(".sidebar-item")[2].classList.add("active");
        }
    }

    // backward-compat alias if somewhere ShowSection (capital S) is used
    window.ShowSection = showSection;

    // Shared delete target
    let deleteTarget = { type: null, id: null };

    // Open delete popup for 'user' or 'report'
    function openDeletePopup(type, id) {
        deleteTarget.type = type;
        deleteTarget.id = id;

        // update popup title/message
        var titleEl = document.getElementById('deletePopupTitle');
        var msgEl = document.getElementById('deletePopupMessage');
        if (titleEl) titleEl.innerText = (type === 'report' ? 'Delete Report' : 'Delete User');
        if (msgEl) msgEl.innerText = (type === 'report'
            ? 'Are you sure you want to delete this report?'
            : 'Are you sure you want to delete this user?');

        var popup = document.getElementById('deletePopup');
        if (popup) popup.style.display = 'flex';
    }

    // Close popup and clear target
    function closeDeletePopup() {
        deleteTarget.type = null;
        deleteTarget.id = null;
        var popup = document.getElementById('deletePopup');
        if (popup) popup.style.display = 'none';
    }

    // Confirm delete button handler
    (function attachConfirmHandler() {
        // If element not present yet, wait briefly and try again (defensive)
        function bind() {
            var btn = document.getElementById('confirmDeleteBtn');
            if (!btn) {
                // try again after small delay (in case DOM hasn't finished)
                setTimeout(bind, 100);
                return;
            }

            btn.addEventListener('click', function () {
                if (!deleteTarget.type || deleteTarget.id == null) {
                    closeDeletePopup();
                    return;
                }

                if (deleteTarget.type === 'user') {
                    // do a redirect to Admin/Delete/{id}
                    window.location.href = '/Admin/Delete/' + encodeURIComponent(deleteTarget.id);
                } else if (deleteTarget.type === 'report') {
                    window.location.href = '/Reports/Delete/' + encodeURIComponent(deleteTarget.id);
                } else {
                    closeDeletePopup();
                }
            });
        }

        bind();
    })();

    // ✅ Auto-open Forgot Password section if redirected with ?section=forgot
    /*window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const section = urlParams.get("section");

        if (section === "forgot") {
            showSection("forgot");
        }
        if (section === "reports") {
            showSection("reports");
        }
    };*/
    window.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);
        const section = params.get("section");

        if (section === "forgot") showSection("forgot");
        else if (section === "reports") showSection("reports");
        else showSection("users");
    });

</script>
